# IMF Commodity Data Fetcher and Analyzer

This project provides a suite of Python scripts designed to automate the fetching of commodity price data from the International Monetary Fund (IMF) API, store it locally, and perform various correlation analyses.

**Core Functionalities:**

*   **Automated Data Acquisition (`main.py`):**
    *   Connects to the IMF API to retrieve the latest Primary Commodity Price System (PCPS) data.
    *   Parses and processes the data, handling different frequencies and units.
    *   Stores structured data in an SQLite database (`database/imf_commodities.sqlite`).
    *   Maintains metadata about available commodity indicators, including their descriptions.
    *   Generates an updated list of active commodity indicators (`database/commodity_indicators_list.txt`).
    *   Logs all operations for monitoring and troubleshooting (`database/imf_data_fetch.log`).

*   **Data Analysis (scripts in `analysis/` directory):**
    *   **`full_correlation_matrix.py`**: Calculates Pearson correlation coefficients for all possible pairs of commodity indicators found in the database, based on user-specified time windows or the maximum common history. Results are saved to `analysis/output/`.
    *   **`dynamic_timeframe_correlation.py`**: Performs a true rolling 60-month window correlation analysis for a user-selected pair of indicators, providing insights into how their relationship evolves over time. Outputs both a CSV file of the rolling correlations and a visual plot (JPG) to `analysis/output/`.

**Technology Stack:**

*   Python 3
*   Libraries: `requests` (for API communication), `pandas` (for data manipulation), `sqlite3` (for database interaction), `matplotlib` (for plotting).

This README provides details on the project structure, setup instructions for each component, and an overview of the database schema.

## Project Structure

```
commodity/
|-- database/
|   |-- imf_commodities.sqlite        # SQLite database for commodity data
|   |-- imf_data_fetch.log            # Log file for the data fetching script
|   |-- commodity_indicators_list.txt # List of available commodity indicators
|
|-- analysis/
|   |-- full_correlation_matrix.py    # Script for all-pairs correlation
|   |-- dynamic_timeframe_correlation.py # Script for rolling correlation of a pair
|   |-- output/
|       |-- (generated CSV and JPG files from analysis scripts)
|
|-- main.py                           # Main script to fetch IMF data
|-- README.md                         # This file
```

## 1. Data Fetching (`main.py`)

*   **Purpose**: Fetches, processes, and stores commodity price data from the IMF API into an SQLite database.
*   **Location**: Root directory.
*   **Output Files Location**: `database/`
    *   `imf_commodities.sqlite`: The SQLite database.
    *   `imf_data_fetch.log`: Log file for script operations.
    *   `commodity_indicators_list.txt`: A text file listing currently active commodity indicators.

### Features (`main.py`)

*   **Data Retrieval**: Fetches data from the IMF's Primary Commodity Price System (PCPS) dataset.
*   **Data Processing**: Parses JSON responses from the API and processes the data using the pandas library.
*   **Database Storage**: Stores the processed commodity data in `database/imf_commodities.sqlite`.
*   **Metadata Management**: Creates/updates a table for indicator metadata and generates `database/commodity_indicators_list.txt`.
*   **Logging**: Maintains a detailed log in `database/imf_data_fetch.log`.

### Setup and Usage (`main.py`)

1.  **Install Dependencies**:
    ```bash
    pip install requests pandas
    ```
2.  **Run the Script**:
    ```bash
    python main.py
    ```
    The script will then:
    *   Create the `database/` directory if it doesn't exist.
    *   Connect to/create `database/imf_commodities.sqlite`.
    *   Fetch data and update `database/commodity_indicators_list.txt`.
    *   Log progress to console and `database/imf_data_fetch.log`.

## 2. Data Analysis Scripts

Located in the `analysis/` directory. These scripts use the data stored in `database/imf_commodities.sqlite`. Output files (CSVs, JPGs) are saved to `analysis/output/`.

### `analysis/full_correlation_matrix.py`

*   **Purpose**: Calculates and ranks Pearson correlation coefficients for every possible pair of commodity indicators.
*   **How it Works**:
    1.  Reads indicator codes from `../database/commodity_indicators_list.txt`.
    2.  Prompts for analysis window (number of months or 'max').
    3.  Fetches monthly data from `../database/imf_commodities.sqlite`.
    4.  Calculates correlations for all pairs based on the chosen timeframe.
    5.  Saves ranked results to `output/full_correlation_results.csv`.
*   **Prerequisites**:
    *   `database/imf_commodities.sqlite` and `database/commodity_indicators_list.txt` (generated by `main.py`).
    *   Python libraries: `pandas`.
*   **Usage** (from the root directory):
    ```bash
    python analysis/full_correlation_matrix.py
    ```
    Or, navigate to `analysis/` and run `python full_correlation_matrix.py`.
*   **Output**:
    *   CSV file in `analysis/output/full_correlation_results.csv`.

### `analysis/dynamic_timeframe_correlation.py`

*   **Purpose**: Performs a true rolling 60-month window correlation analysis for a user-specified pair of indicators.
*   **How it Works**:
    1.  Prompts the user for two indicator codes.
    2.  Reads indicator info from `../database/commodity_indicators_list.txt`.
    3.  Fetches monthly data for the pair from `../database/imf_commodities.sqlite`.
    4.  Calculates correlations for a 60-month window, sliding one month at a time through their common history.
    5.  Saves the results to a CSV file in `analysis/output/` (e.g., `true_rolling_60m_correlation_CODE1_CODE2.csv`).
    6.  Generates and saves a JPG plot of the rolling correlation to `analysis/output/` (e.g., `true_rolling_60m_correlation_CODE1_CODE2.jpg`).
*   **Prerequisites**:
    *   `database/imf_commodities.sqlite` and `database/commodity_indicators_list.txt`.
    *   Python libraries: `pandas`, `matplotlib`. (Run `pip install matplotlib` if not installed).
*   **Usage** (from the root directory):
    ```bash
    python analysis/dynamic_timeframe_correlation.py
    ```
    Or, navigate to `analysis/` and run `python dynamic_timeframe_correlation.py`.
*   **Output**:
    *   CSV file in `analysis/output/` (e.g., `true_rolling_60m_correlation_CODE1_CODE2.csv`).
    *   JPG plot in `analysis/output/` (e.g., `true_rolling_60m_correlation_CODE1_CODE2.jpg`).


## Database Schema (`database/imf_commodities.sqlite`)

### `commodity_prices` Table

| Column                  | Type      | Description                                                                 |
| ----------------------- | --------- | --------------------------------------------------------------------------- |
| `id`                    | INTEGER   | Primary Key, Autoincrement                                                  |
| `frequency_code`        | TEXT      | Frequency of the observation (e.g., M, A)                                   |
| `area_code`             | TEXT      | Reference area code (e.g., W00 for World)                                   |
| `indicator_code`        | TEXT      | Commodity indicator code (e.g., PCOALAU for Coal, Australia)                |
| `unit_code`             | TEXT      | Unit of measure (e.g., USD, IX)                                             |
| `observation_date`      | TEXT      | Date of the observation (YYYY-MM-DD, YYYY-MM, or YYYY)                      |
| `observation_value`     | REAL      | Value of the observation                                                    |
| `data_series_key`       | TEXT      | Composite key for the data series (e.g., M.W00.PGOLD.USD)                   |
| `last_fetched_script`   | TIMESTAMP | Timestamp of when the record was last fetched/updated by the script         |
| *Unique Constraint*     |           | `(data_series_key, observation_date)`                                       |

### `indicators_metadata` Table

| Column                        | Type      | Description                                                              |
| ----------------------------- | --------- | ------------------------------------------------------------------------ |
| `indicator_code`              | TEXT      | Primary Key, Commodity indicator code                                    |
| `description`                 | TEXT      | Description of the commodity indicator                                   |
| `first_seen_script_run`       | TIMESTAMP | Timestamp of when the indicator was first recorded by the script         |
| `last_seen_active_script_run` | TIMESTAMP | Timestamp of the last script run where this indicator was seen as active |
| `is_currently_active`         | INTEGER   | Boolean (0 or 1) indicating if the indicator is currently active         |